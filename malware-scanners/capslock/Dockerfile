# Use Go 1.23 in the builder stage
FROM golang:1.23-alpine AS builder

# Install necessary packages for building
RUN apk add --no-cache git

# Set the working directory inside the container
WORKDIR /app

# Install capslock using go install (using Go 1.23)
RUN go install github.com/google/capslock/cmd/capslock@latest

# Final stage - Use Go 1.23 for running capslock
FROM golang:1.23-alpine

# Install necessary packages for git
RUN apk add --no-cache git

# Copy the Go binary for capslock from the builder stage
COPY --from=builder /go/bin/capslock /usr/local/bin/capslock

# Set the working directory
WORKDIR /app

# Define environment variables for repository and tag
ENV REPO_URL=""
ENV TAG=""

# Copy the capslock_scan.sh script into the container
COPY capslock_scan.sh /usr/local/bin/capslock_scan.sh

# Make the capslock_scan.sh script executable
RUN chmod +x /usr/local/bin/capslock_scan.sh

# Set the entrypoint script to capslock_scan.sh
ENTRYPOINT ["/usr/local/bin/capslock_scan.sh"]